name: Manual Service Restart

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to restart'
        required: true
        default: 'all'
        type: choice
        options:
          - gunicorn
          - celery
          - celery-beat
          - redis
          - rabbitmq
          - all
      reason:
        description: 'Reason for restart'
        required: true
        default: 'Manual trigger via GitHub Actions'

jobs:
  restart:
    runs-on: self-hosted
    env:
      SERVICE: ${{ github.event.inputs.service || 'all' }}
      REASON:  ${{ github.event.inputs.reason  || 'Manual trigger' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Restart/Reload services (run systemctl as ubuntu, no password prompt)
        shell: bash
        run: |
          set -euo pipefail
          echo "Service: ${SERVICE}"
          echo "Reason:  ${REASON}"

          restart_svc() { sudo -u ubuntu -n systemctl restart "$1"; }
          reload_svc()  { sudo -u ubuntu -n systemctl reload "$1" || sudo -u ubuntu -n systemctl restart "$1"; }
          is_active()   { sudo -u ubuntu -n systemctl is-active --quiet "$1"; }

          case "${SERVICE}" in
            gunicorn)
              reload_svc gunicorn
              sleep 3
              is_active gunicorn || { echo "‚ùå Gunicorn not active"; exit 1; }
              echo "‚úÖ Gunicorn reloaded successfully"
              ;;
            celery)
              restart_svc celery
              restart_svc celery-beat
              sleep 5
              is_active celery && is_active celery-beat || { echo "‚ùå Celery or Celery Beat not active"; exit 1; }
              echo "‚úÖ Celery services restarted successfully"
              ;;
            celery-beat)
              restart_svc celery-beat
              sleep 3
              is_active celery-beat || { echo "‚ùå Celery Beat not active"; exit 1; }
              echo "‚úÖ Celery Beat restarted successfully"
              ;;
            redis)
              restart_svc redis-server
              sleep 3
              is_active redis-server || { echo "‚ùå Redis not active"; exit 1; }
              echo "‚úÖ Redis restarted successfully"
              ;;
            rabbitmq)
              restart_svc rabbitmq-server
              sleep 10
              is_active rabbitmq-server || { echo "‚ùå RabbitMQ not active"; exit 1; }
              echo "‚úÖ RabbitMQ restarted successfully"
              ;;
            all)
              echo "Restarting all services in dependency order..."
              restart_svc redis-server
              sleep 3
              restart_svc rabbitmq-server
              sleep 10
              restart_svc celery
              restart_svc celery-beat
              sleep 5
              reload_svc gunicorn
              sleep 3
              failures=()
              for s in redis-server rabbitmq-server celery celery-beat gunicorn; do
                if ! is_active "$s"; then failures+=("$s"); fi
              done
              if [ ${#failures[@]} -eq 0 ]; then
                echo "‚úÖ All services healthy"
              else
                echo "‚ùå Unhealthy services: ${failures[*]}"
                exit 1
              fi
              ;;
            *)
              echo "‚ùå Unknown service: ${SERVICE}"
              exit 1
              ;;
          esac

          echo "üìä Final service status:"
          sudo -u ubuntu -n systemctl status gunicorn celery celery-beat redis-server rabbitmq-server --no-pager --lines=1 || true
